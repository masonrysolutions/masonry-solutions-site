<script>
  // AUTO GALLERY LOADER (jsDelivr) — no GitHub API rate-limit issues
  const OWNER = "mansonrysolutions";
  const REPO  = "masonry-solutions-site";
  const BRANCH = "main"; // if your repo uses master, change to "master"
  const FOLDER_PREFIX = "assets/img/gallery/";

  const grid = document.getElementById("galleryGrid");
  const meta = document.getElementById("galleryMeta");
  const errBox = document.getElementById("galleryError");
  const search = document.getElementById("gallerySearch");

  let allFiles = [];

  function isImage(path){
    const p = path.toLowerCase();
    return p.endsWith(".jpg") || p.endsWith(".jpeg") || p.endsWith(".png") || p.endsWith(".webp");
    // If your iPhone uploaded HEIC, tell me and I’ll add .heic support properly.
  }

  function render(list){
    grid.innerHTML = "";
    if (!list.length){
      meta.textContent = "No photos found.";
      return;
    }

    meta.textContent = `${list.length} photo${list.length === 1 ? "" : "s"} shown`;

    const frag = document.createDocumentFragment();
    for (const path of list){
      const item = document.createElement("div");
      item.className = "gallery-item";

      const img = document.createElement("img");
      img.loading = "lazy";
      img.alt = path.split("/").pop().replace(/\.[^/.]+$/, "");
      img.src = `https://cdn.jsdelivr.net/gh/${OWNER}/${REPO}@${BRANCH}/${path}`;

      const cap = document.createElement("div");
      cap.className = "gallery-caption";
      cap.textContent = path.split("/").pop();

      item.appendChild(img);
      item.appendChild(cap);
      frag.appendChild(item);
    }
    grid.appendChild(frag);
  }

  function showError(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
    meta.textContent = "Couldn’t load photos.";
  }

  // Get a file list from jsDelivr’s package API
  fetch(`https://data.jsdelivr.com/v1/package/gh/${OWNER}/${REPO}@${BRANCH}`)
    .then(r => r.ok ? r.json() : Promise.reject(r))
    .then(data => {
      const files = (data.files || []);

      // Flatten the tree into paths
      const paths = [];
      function walk(nodes, prefix=""){
        for (const n of nodes){
          if (n.type === "file") paths.push(prefix + n.name);
          if (n.type === "directory") walk(n.files || [], prefix + n.name + "/");
        }
      }
      walk(files, "");

      allFiles = paths
        .filter(p => p.startsWith(FOLDER_PREFIX))
        .filter(p => isImage(p));

      // show newest-ish first (if you name them with dates/01/02 etc)
      allFiles.sort((a,b) => b.localeCompare(a));

      if (!allFiles.length){
        showError("No images found in assets/img/gallery/. Upload JPG/PNG/WEBP images into that folder in GitHub, then refresh.");
        return;
      }

      render(allFiles);
    })
    .catch(() => {
      showError("Gallery could not load images. Check OWNER/REPO/BRANCH and that images are in assets/img/gallery/.");
    });

  search.addEventListener("input", () => {
    const q = (search.value || "").trim().toLowerCase();
    if (!q) return render(allFiles);
    render(allFiles.filter(p => p.toLowerCase().includes(q)));
  });
<script>
  // Auto Gallery Loader (robust)
  // - Detects your default branch automatically
  // - Loads JPG/JPEG/PNG/WEBP/HEIC
  // - Shows a clear error message if something is wrong

  const OWNER = "mansonrysolutions";
  const REPO  = "masonry-solutions-site";
  const FOLDER_PATH = "assets/img/gallery";

  const grid  = document.getElementById("galleryGrid");
  const meta  = document.getElementById("galleryMeta");
  const errBox = document.getElementById("galleryError");
  const search = document.getElementById("gallerySearch");

  let allFiles = [];

  function isImage(name){
    const n = (name || "").toLowerCase();
    return n.endsWith(".jpg") || n.endsWith(".jpeg") || n.endsWith(".png") || n.endsWith(".webp") || n.endsWith(".heic");
  }

  function showError(msg){
    if (errBox){
      errBox.style.display = "block";
      errBox.textContent = msg;
    }
    if (meta) meta.textContent = "Couldn’t load photos.";
  }

  function render(list){
    if (!grid || !meta) return;

    grid.innerHTML = "";
    meta.textContent = `${list.length} photo${list.length === 1 ? "" : "s"} shown`;

    if (!list.length){
      meta.textContent = "No photos found in assets/img/gallery/";
      return;
    }

    const frag = document.createDocumentFragment();
    for (const f of list){
      const item = document.createElement("div");
      item.className = "gallery-item";

      const img = document.createElement("img");
      img.loading = "lazy";
      img.alt = (f.name || "").replace(/\.[^/.]+$/, "");
      img.src = f.download_url;

      const cap = document.createElement("div");
      cap.className = "gallery-caption";
      cap.textContent = f.name;

      item.appendChild(img);
      item.appendChild(cap);
      frag.appendChild(item);
    }
    grid.appendChild(frag);
  }

  async function getDefaultBranch(){
    const url = `https://api.github.com/repos/${OWNER}/${REPO}`;
    const r = await fetch(url, { headers: { "Accept": "application/vnd.github+json" }});
    if (!r.ok) throw new Error(`Repo lookup failed (${r.status})`);
    const data = await r.json();
    return data.default_branch || "main";
  }

  async function loadFiles(branch){
    const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FOLDER_PATH}?ref=${encodeURIComponent(branch)}`;
    const r = await fetch(url, { headers: { "Accept": "application/vnd.github+json" }});
    if (!r.ok) throw new Error(`Folder lookup failed (${r.status}) — check folder path and that files exist`);
    const data = await r.json();
    if (!Array.isArray(data)) throw new Error("Unexpected folder response");
    return data.filter(x => x && x.type === "file" && isImage(x.name));
  }

  (async () => {
    try {
      if (meta) meta.textContent = "Loading photos…";

      const branch = await getDefaultBranch();
      const files = await loadFiles(branch);

      allFiles = files.sort((a,b) => (b.name || "").localeCompare(a.name || ""));
      render(allFiles);

      // Search
      if (search){
        search.addEventListener("input", () => {
          const q = (search.value || "").trim().toLowerCase();
          if (!q) return render(allFiles);
          render(allFiles.filter(f => (f.name || "").toLowerCase().includes(q)));
        });
      }

      if (!allFiles.length){
        showError("I reached assets/img/gallery/ but found no JPG/PNG/WEBP/HEIC images. Upload photos into assets/img/gallery/ and refresh.");
      }
    } catch (e) {
      showError(
        "Gallery could not load images.\n\n" +
        "Fix checklist:\n" +
        "1) Folder must be exactly: assets/img/gallery (all lowercase)\n" +
        "2) Photos must be committed (not just uploaded)\n" +
        "3) Photo files should be JPG/PNG/WEBP (HEIC is supported here too)\n\n" +
        "Technical:\n" + (e && e.message ? e.message : String(e))
      );
    }
  })();
</script>

<script>
  // AUTO GALLERY LOADER (jsDelivr) — no GitHub API rate-limit issues
  const OWNER = "mansonrysolutions";
  const REPO  = "masonry-solutions-site";
  const BRANCH = "main"; // if your repo uses master, change to "master"
  const FOLDER_PREFIX = "assets/img/gallery/";

  const grid = document.getElementById("galleryGrid");
  const meta = document.getElementById("galleryMeta");
  const errBox = document.getElementById("galleryError");
  const search = document.getElementById("gallerySearch");

  let allFiles = [];

  function isImage(path){
    const p = path.toLowerCase();
    return p.endsWith(".jpg") || p.endsWith(".jpeg") || p.endsWith(".png") || p.endsWith(".webp");
    // If your iPhone uploaded HEIC, tell me and I’ll add .heic support properly.
  }

  function render(list){
    grid.innerHTML = "";
    if (!list.length){
      meta.textContent = "No photos found.";
      return;
    }

    meta.textContent = `${list.length} photo${list.length === 1 ? "" : "s"} shown`;

    const frag = document.createDocumentFragment();
    for (const path of list){
      const item = document.createElement("div");
      item.className = "gallery-item";

      const img = document.createElement("img");
      img.loading = "lazy";
      img.alt = path.split("/").pop().replace(/\.[^/.]+$/, "");
      img.src = `https://cdn.jsdelivr.net/gh/${OWNER}/${REPO}@${BRANCH}/${path}`;

      const cap = document.createElement("div");
      cap.className = "gallery-caption";
      cap.textContent = path.split("/").pop();

      item.appendChild(img);
      item.appendChild(cap);
      frag.appendChild(item);
    }
    grid.appendChild(frag);
  }

  function showError(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
    meta.textContent = "Couldn’t load photos.";
  }

  // Get a file list from jsDelivr’s package API
  fetch(`https://data.jsdelivr.com/v1/package/gh/${OWNER}/${REPO}@${BRANCH}`)
    .then(r => r.ok ? r.json() : Promise.reject(r))
    .then(data => {
      const files = (data.files || []);

      // Flatten the tree into paths
      const paths = [];
      function walk(nodes, prefix=""){
        for (const n of nodes){
          if (n.type === "file") paths.push(prefix + n.name);
          if (n.type === "directory") walk(n.files || [], prefix + n.name + "/");
        }
      }
      walk(files, "");

      allFiles = paths
        .filter(p => p.startsWith(FOLDER_PREFIX))
        .filter(p => isImage(p));

      // show newest-ish first (if you name them with dates/01/02 etc)
      allFiles.sort((a,b) => b.localeCompare(a));

      if (!allFiles.length){
        showError("No images found in assets/img/gallery/. Upload JPG/PNG/WEBP images into that folder in GitHub, then refresh.");
        return;
      }

      render(allFiles);
    })
    .catch(() => {
      showError("Gallery could not load images. Check OWNER/REPO/BRANCH and that images are in assets/img/gallery/.");
    });

  search.addEventListener("input", () => {
    const q = (search.value || "").trim().toLowerCase();
    if (!q) return render(allFiles);
    render(allFiles.filter(p => p.toLowerCase().includes(q)));
  });
</script>
